{{- $depth := .depth -}}
{{- $referrer := .referrer -}}
{{- $sources := .sources -}}
{{- $backrefs := .backrefs -}}
{{- $site := .site -}}

<!-- maxing out at 3 children deep -->
{{- if lt $depth 4 -}}

{{- range .sources -}}

	{{- $page := $site.GetPage . -}}
	{{- $path := (printf "/%s" $page.Path) -}}
	{{- $title := $page.Title -}}{{- if eq $title "" -}}{{- $title = humanize $page.File.BaseFileName -}}{{- end -}}

	<!-- will not enter if there is no referrer match -->
	{{- range where $backrefs "referrer" "eq" $path -}}

	<!-- only creates lists where referrer has sources -->
	{{- if gt (len .sources) 0 -}}

	<li class="spread-down" data-referrer="{{ $referrer }}">
		<a href="{{ $page.Permalink }}">{{- $title -}}</a>
		<span>{{- printf "L%d" $depth -}}</span>
		<ul>
			{{- partial "backlink-recurse.html" (dict "depth" (add $depth 1) "referrer" $path "sources" .sources "backrefs" $backrefs "site" $site) -}}
		</ul>
	</li>
	<!-- end if sources > 1 -->
	{{- else -}}
		<!-- backref terminus -->
		<li data-referrer="{{ $referrer }}"><a href="{{ $page.Permalink }}">{{- $title -}}</a></li>
	{{- end -}}

	<!-- end backrefs range -->
	{{- else -}}
		<!-- backref terminus -->
		<li data-referrer="{{ $referrer }}"><a href="{{ $page.Permalink }}">{{- $title -}}</a></li>
	{{- end -}}

	<!-- end sources range -->
{{- end -}}

<!-- end if depth > 4 -->
{{- end -}}
